#!/bin/bash

ProgName=$(basename $0)


if [ $(id -u) -ne 0 ]
then
   echo "Erreur: CydraManagers doit etre lancé en tant qu'administrateur !"
   echo	"       \ Correction: sudo cydramanager"
   exit 1
fi

sub_help(){
    echo "Usage: $ProgName [options]"
    echo "Liste des commandes disponibles"
    echo "    -V  = --version  = Version du logiciel"
    echo "    -Vm = --moreinfo = Affiche plus d'information a propos du gestionnaire de packets"
    echo "    -v  = --verbose  = Affiche d'autre information"
    echo "    -u  = --update   = Fais la mise a jour du systeme"
    echo "    -i  = --install  = Installe un logiciel de votre choix"
    echo "    -h  = --help     = Ouvre un menu d'aide"
    echo ""
    echo ""
}

update(){

	shopt -s nullglob
        shopt -s dotglob

        echo ":: Récupération des données"
        echo "            |"
        echo "             - core"
	echo ":: Extraction en cours.."
        sudo wget archlinux.datagr.am/core/os/x86_64/core.db.tar.gz -q -P /etc/cydramanager/updatedata
        sudo tar xf /etc/cydramanager/updatedata/core.db.tar.gz --directory /etc/cydramanager/updatedata
        clear
        echo ":: Récupération des données  [FAIS]"
        echo "            |"
        echo "             - core"
	echo ":: Extraction en cours... [FAIS]"
	echo ":: Vérification en cours"
	start
}

installupdate(){
	#VARIABLES

	VarAcl=$(grep -r -l acl"-" /etc/cydramanager/updatedata)            VarAclVersion=$(sed -n 11p $acl)

	extA="pkg.tar.xz"
	extB="pkg.tar.zst"
	archA="any"
	archB="x86_64"
	cache="/etc/cydramanager/cache"
	result="/etc/cydramanager/cache/result"
	mirror="http://ftp.u-strasbg.fr/linux/distributions/archlinux/core/os/x86_64/"

	#PREPARATION
	sudo mkdir /etc/cydramanager/cache
	sudo mkdir /etc/cydramanager/cache/result

	#TELECHARGEMENT
	wget $mirror"acl-"$VarAclVersion"-"$archB"."$extB -P $cache
	
	#....
	
	#NETTOYAGE
	sudo rm -rf /etc/cydramanager/cache/
	sudo rm -rf /etc/cydramanager/updatedata/*
	echo ":: Mise a jour terminé !"
	echo
}

start(){

	echo -n -e "\033[0;36mVoulez vous procédé a l'installation? ---------- [O|N] "
	read process

	if [ "$process" = "o" ]; then
    		echo ":: Installation en cours.."
		echo "       \_ Telechargement des donnés"
		installupdate
	else
    		echo ":: Annulation.."
		exit 0
    	fi

}

send_to_help(){
	echo "Vous n'utilisez pas la commande correctement"
	echo "             Usage: 'cydramanager --help'"
	echo
}

more_info(){
echo "Download command: wget"
echo "Mirror: http://ftp.u-strasbg.fr/linux/distributions/archlinux/ (WARNING: THIS IS NOT A ARCH DISTRIBUTION !)"
echo "Version: V01 Beta Test"
echo "Author: AcTh2"
echo "Principal OS: CydraProject"
echo ""
}

sub_version(){
echo "'\'        CydraManagers     '\'"
echo " '\'      V01 - BETA TEST     '\'"
echo "  '\'                          '\'"
echo "   '\'                          '\'"
echo "    '\'                          '\'"
echo "     '\'   Create by AcTh2        '\'"
}
subcommand=$1
case $subcommand in

    			  "")
        send_to_help
        ;;

    "-Vm" | "--moreinfo" | "-moreinfo")
        more_info
        ;;

    "-help" | "-h" | "--help")
        sub_help
        ;;

    "-V" | "-version" | "--version")
        sub_version
        ;;

    "-u" | "-update" | "--update")
	update
	;;
    *)
        shift
        sub_${subcommand} $@
        if [ $? = 127 ]; then
            echo "Erreur: '$subcommand' n'éxiste pas ou n'est pas reconnu." >&2
            echo "       Lancez 'cydramanager --help' pour avoir la liste des commandes" >&2
            exit 1
        fi
        ;;
esac
