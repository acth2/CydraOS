#!/bin/bash

MIRROR_LIST="https://mirror.thekinrar.fr/archlinux/"

function help {
    echo "Usage: cydramanager [options]"
    echo ""
    echo "Options:"
    echo " -h, --help: display help message"
    echo " -u, --update: update package list from mirror"
    echo " -i, --install <package(s)>: install package(s)"
    echo " -r, --remove <package(s)>: remove package(s)"
}

function update_packages {
    echo "Updating package list..."
    wget -q -O /tmp/packages.db ${MIRROR_LIST}/core/os/x86_64/core.db
    if [ "$?" -ne 0 ]; then
        echo "Error: failed to download package list."
        exit 1
    fi
    echo "Package list updated successfully."
}

function install_packages {
    shift
    if [ "$#" -eq 0 ]; then
        echo "Error: missing package name."
        help
        exit 1
    fi
    echo "Installing package(s) $@"
    for package_name in $@; do
        echo "Downloading $package_name..."
        wget -q -O /tmp/${package_name}.tar.xz ${MIRROR_LIST}/core/os/x86_64/${package_name}-*.pkg.tar.xz
        if [ "$?" -ne 0 ]; then
            echo "Error: failed to download package ${package_name}."
            exit 1
        fi
        echo "Extracting $package_name..."
        tar -xf /tmp/${package_name}.tar.xz -C /
        if [ "$?" -ne 0 ]; then
            echo "Error: failed to extract package ${package_name}."
            exit 1
        fi
        echo "Package ${package_name} installed successfully."
    done
}

function remove_packages {
    shift
    if [ "$#" -eq 0 ]; then
        echo "Error: missing package name."
        help
        exit 1
    fi
    echo "Removing package(s) $@"
    for package_name in $@; do
        echo "Removing $package_name..."
        rm -rf /usr/lib/${package_name}
        if [ "$?" -ne 0 ]; then
            echo "Error: failed to remove package ${package_name}."
            exit 1
        fi
        echo "Package ${package_name} removed successfully."
    done
}

if [ "$#" -eq 0 ]; then
    help
    exit 1
fi

while [ "$#" -gt 0 ]; do
    case "$1" in
        -h|--help)
            help
            exit 0
            ;;
        -u|--update)
            update_packages
            shift
            ;;
        -i|--install)
            COMMAND_INSTALL=$1
            shift
            install_packages $@
            shift $#
            ;;
        -r|--remove)
            COMMAND_REMOVE=$1
            shift
            remove_packages $@
            shift $#
            ;;
        *)
            echo "Error: unknown option $1"
            help
            exit 1
            ;;
    esac
done
