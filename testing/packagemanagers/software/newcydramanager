#!/bin/bash

# Couleurs
rouge='\033[1;31m'
bleu_clair='\033[1;36m'
vert_clair='\033[1;32m'
normal='\033[0m'

# Constantes
MIRROR="https://mirror.thekinrar.fr/archlinux"
BRANCHES=("core" "community")
INSTALL_DIR="/tmp/cydramanager"
BIN_DIR="/usr/local/bin"
PACKAGES_FILE="$INSTALL_DIR/packages.txt"

# Fonctions
install_packages() { 
  echo -e "${bleu_clair}Installation des paquets : $*${normal}"
  for package in "$@"
  do
    echo -e "${bleu_clair}Téléchargement de $package${normal}"
    wget -q "$MIRROR/$BRANCH/$package" -P "$INSTALL_DIR"
    echo -e "${bleu_clair}Décompression de $package${normal}"
    tar -xf "$INSTALL_DIR/$package" -C "$INSTALL_DIR"
    echo -e "${bleu_clair}Installation de $package${normal}"
    cd "$INSTALL_DIR/${package%.tar.xz}/" && makepkg -sri --noconfirm
    cd "$INSTALL_DIR"
  done
}

remove_packages() {
  echo -e "${rouge}Suppression des paquets : $*${normal}"
  for package in "$@"
  do
    echo -e "${rouge}Désinstallation de $package${normal}"
    pacman -Rs --noconfirm "$package"
  done
}

update_system() {
  echo -e "${vert_clair}Mise à jour du système${normal}"
  pacman -Syu --noconfirm
}

# Vérification de l'utilisateur root
if [[ $EUID -ne 0 ]]; then
  echo -e "${rouge}Ce script doit être exécuté en tant que root${normal}" >&2
  exit 1
fi

# Création du répertoire d'installation
mkdir -p "$INSTALL_DIR"

# Téléchargement de la liste des paquets
for branch in "${BRANCHES[@]}"
do
  wget -q "$MIRROR/$branch/os/x86_64/" -O - | awk -F '"' '/href/{print $2}' | grep "^$branch/" | grep "\.tar\.xz$" >> "$PACKAGES_FILE"
done

# Traitement des arguments
case "$1" in
  install)
    shift
    install_packages "$@"
    ;;
  remove)
    shift
    remove_packages "$@"
    ;;
  update)
    update_system
    ;;
  *)
    echo -e "${rouge}Commande inconnue. Les commandes disponibles sont : install, remove, update.${normal}" >&2
    exit 1
    ;;
esac
